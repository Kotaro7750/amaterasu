# バディ方式メモリ管理

linuxにおいて，連続した物理フレーム確保要求をできるだけ「外部フラグメンテーション(ページ単位での虫食い)」を起こさないように行うためのメモリ管理手法．

<https://codezine.jp/article/detail/9325>

## アルゴリズム
ある領域を2^L個のブロックに分けて考える．この時，order-Lのバディ方式メモリ管理という．
また，1,2,4,...,2^L個ごとのまとまりのそれぞれをorder-0,1,...,Lのブロックという．

初期状態ではorder-Lのブロックが一つある．

### 割り当て
n個の連続したブロックの割り当てを行うときを考える．
割り当ての際は2のべき乗を単位として行うため，log n の天井関数をNとすると，2^Nのブロックを割り当てることになる．

まずはorder-Nのブロックが空いていないかを調べる．
空いているならばorder-Nのブロックを割り当てる．

もし空いていないならば，order-N+1のブロックが空いていないか調べる．
そのように調べていって，order-Mのブロックが初めて空いていると分かったとする．

order-Mのブロックを２等分して，order-M-1のブロックを２つ生成する．
そして，２つの内一つはそのままに，もう一つはさらなる再帰的分割の対象とする．

このように分割を繰り返していくとそのうちorder-Nのブロックが生成されるので，それを割り当てる．

### 解放
order-Nのブロックを解放するとする．
order-Nの空きブロックリストに解放したブロックを追加する．
このとき，割り当ての際分割した片割れ（バディという）もorder-Nの空きブロックリストにあったら，結合してorder-N+1の空きブロックとする．
同様の結合を結合できるブロックがなくなるまで繰り返す．

## 利点
ただの線形リストで管理するのに比べ，確保・解放にかかる時間がO(logN)で終わる．
また，フラグメンテーションが起こりにくい．

## 欠点
割り当てを2のべき乗で行うため，無駄が多い．
